// ============================================
// SC Sitio Profiling System
// Entity-Relationship Diagram (DBML)
// ============================================
// Normalized schema for sitio profiling data
// ============================================

Project sc_sitio_profiling {
  database_type: 'PostgreSQL'
  Note: 'South Cotabato Sitio Profiling System - Community data collection and monitoring'
}

// ============================================
// ENUMS
// ============================================

enum official_type {
  local [note: 'Local barangay/sitio official']
  rst [note: 'Resident Support Team official']
}

enum user_role {
  superadmin [note: 'Full system access']
  admin [note: 'Can manage sitios and data']
  viewer [note: 'Read-only access']
}

enum audit_action {
  login
  logout
  create
  update
  delete
  view
  export
  import
}

enum audit_resource_type {
  user
  sitio
  sitio_data
  project
  system
}

enum mobile_signal {
  none [note: 'No mobile signal']
  two_g [note: '2G']
  three_g [note: '3G']
  four_g [note: '4G']
  five_g [note: '5G']
}

enum facility_exists {
  yes
  no
}

enum road_exists {
  yes
  no
}

enum water_source_exists {
  yes
  no
}

enum students_per_room {
  less_than_46 [note: 'Less than 46 students']
  from_46_to_50 [note: '46-50 students']
  from_51_to_55 [note: '51-55 students']
  more_than_56 [note: 'More than 56 students']
  no_classroom [note: 'No classroom']
}

enum food_security {
  secure [note: 'Food secure']
  seasonal_scarcity [note: 'Seasonal scarcity']
  critical_shortage [note: 'Critical shortage']
}

enum priority_rating {
  not_needed [note: '0 - Not needed']
  low [note: '1 - Low priority']
  medium [note: '2 - Medium priority']
  very_urgent [note: '3 - Very urgent']
}

// ============================================
// LOCATION HIERARCHY
// ============================================

Table municipalities {
  id integer [pk, increment]
  name varchar(100) [not null]
  
  Note: 'Municipality/City reference table'
}

Table barangays {
  id integer [pk, increment]
  municipality_id integer [not null, ref: > municipalities.id]
  name varchar(100) [not null]
  
  indexes {
    municipality_id [name: 'idx_barangays_municipality']
    (municipality_id, name) [unique, name: 'idx_barangays_unique_name']
  }
  
  Note: 'Barangay reference table'
}

// ============================================
// CORE ENTITIES
// ============================================

Table sitios {
  id integer [pk, increment]
  name varchar(255) [not null]
  barangay_id integer [not null, ref: > barangays.id]
  sitio_code varchar(50) [note: 'Purok/Sitio code identifier']
  coordinates_lat decimal [not null]
  coordinates_lng decimal [not null]
  
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  
  indexes {
    barangay_id [name: 'idx_sitios_barangay']
    name [name: 'idx_sitios_name']
    (barangay_id, name) [unique, name: 'idx_sitios_unique_name']
  }
  
  Note: 'Core sitio (community) entity - contains only identification and location data'
}

Table projects {
  id integer [pk, increment]
  title varchar(255) [not null]
  description text [not null]
  location_lat decimal [not null, note: 'Project location latitude']
  location_lng decimal [not null, note: 'Project location longitude']
  cost decimal [not null, default: 0, note: 'Total project cost in PHP']
  project_date date [not null, note: 'Date when the project was implemented']
  
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  
  indexes {
    title [name: 'idx_projects_title']
    project_date [name: 'idx_projects_date']
    created_at [name: 'idx_projects_created']
  }
  
  Note: 'Development projects implemented across sitios - tracks investments and community development'
}

Table project_sitios {
  id integer [pk, increment]
  project_id integer [not null, ref: > projects.id]
  sitio_id integer [not null, ref: > sitios.id]
  
  indexes {
    project_id [name: 'idx_project_sitios_project']
    sitio_id [name: 'idx_project_sitios_sitio']
    (project_id, sitio_id) [unique, name: 'idx_project_sitios_unique']
  }
  
  Note: 'Many-to-many relationship between projects and sitios - tracks which sitios benefit from each project'
}

Table project_images {
  id integer [pk, increment]
  project_id integer [not null, ref: > projects.id]
  image_data text [not null, note: 'Base64 encoded image string']
  display_order integer [not null, default: 0, note: 'Order in which images are displayed']
  
  created_at timestamp [not null, default: `now()`]
  
  indexes {
    project_id [name: 'idx_project_images_project']
    (project_id, display_order) [name: 'idx_project_images_order']
  }
  
  Note: 'Project images (max 5 per project) - stores base64 encoded compressed images for visual documentation'
}

Table sitio_data {
  id integer [pk, increment]
  sitio_id integer [not null, ref: > sitios.id]
  year_recorded integer [not null, note: 'Year this data was recorded']
  recorded_at timestamp [not null, default: `now()`]
  
  // SECTION A: Sitio Classification
  is_gida boolean [not null, default: false, note: 'Geographically Isolated and Disadvantaged Area']
  is_indigenous boolean [not null, default: false, note: 'Indigenous Community']
  is_conflict_affected boolean [not null, default: false, note: 'Conflict-Affected Area (Past 3 years)']
  
  // Main Access
  access_paved_road boolean [not null, default: false]
  access_unpaved_road boolean [not null, default: false]
  access_footpath boolean [not null, default: false]
  access_boat boolean [not null, default: false]
  
  // SECTION B: Population & Demographics
  total_population integer [not null, default: 0]
  total_households integer [not null, default: 0]
  registered_voters integer [default: 0]
  labor_force_count integer [default: 0]
  school_age_children integer [default: 0]
  
  population_male integer [not null, default: 0]
  population_female integer [not null, default: 0]
  
  // Vulnerable Groups
  muslim_count integer [default: 0]
  ip_count integer [default: 0]
  seniors_count integer [default: 0]
  labor_force_60_to_64_count integer [default: 0]
  unemployed_count integer [default: 0]
  no_birth_cert_count integer [default: 0]
  no_national_id_count integer [default: 0]
  out_of_school_youth integer [default: 0]
  
  // SECTION C: Basic Utilities & Connectivity
  households_with_toilet integer [default: 0]
  households_with_electricity integer [default: 0]
  
  // Electricity Sources
  electricity_grid integer [default: 0]
  electricity_solar integer [default: 0]
  electricity_battery integer [default: 0]
  electricity_generator integer [default: 0]
  
  mobile_signal mobile_signal [not null, default: 'none']
  households_with_internet integer [default: 0]
  
  // SECTION F: Education
  students_per_room students_per_room
  
  // SECTION H: Livelihood & Agriculture
  private_household_workers integer [default: 0]
  private_establishment_workers integer [default: 0]
  government_workers integer [default: 0]
  self_employed_workers integer [default: 0]
  employer_workers integer [default: 0]
  ofw_workers integer [default: 0]
  
  average_daily_income decimal [default: 0]
  
  number_of_farmers integer [default: 0]
  number_of_associations integer [default: 0]
  estimated_farm_area_hectares decimal [default: 0]
  
  // SECTION I: Safety & Risk
  food_security food_security
  
  Note: 'Sitio profiling data with year-over-year tracking mapped to survey sections'
}

// ============================================
// SECTION D: COMMUNITY FACILITIES
// ============================================

Table sitio_facilities {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  facility_type varchar(50) [not null, note: 'healthCenter, pharmacy, communityToilet, kindergarten, elementarySchool, highSchool, madrasah, market']
  exists facility_exists [not null]
  count integer [note: 'Number of facilities if exists=yes']
  distance_to_nearest decimal [note: 'Distance in km if exists=no']
  condition integer [note: 'Condition rating 1-5 (1=Bad, 5=Excellent)']
  
  indexes {
    sitio_data_id [name: 'idx_facilities_sitio_data']
    (sitio_data_id, facility_type) [unique, name: 'idx_facilities_unique']
  }
  
  Note: 'Community facilities inventory and condition (Section D)'
}

// ============================================
// SECTION E: ROADS & INTERNAL INFRASTRUCTURE
// ============================================

Table sitio_infrastructure {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  road_type varchar(50) [not null, note: 'asphalt, concrete, gravel, natural']
  exists road_exists [not null]
  length_km decimal [note: 'Length in kilometers if exists=yes']
  condition integer [note: 'Condition rating 1-5 (1=Bad, 5=Excellent)']
  
  indexes {
    sitio_data_id [name: 'idx_infrastructure_sitio_data']
    (sitio_data_id, road_type) [unique, name: 'idx_infrastructure_unique']
  }
  
  Note: 'Road infrastructure inventory and condition (Section E)'
}

// ============================================
// SECTION G: WATER & SANITATION
// ============================================

Table sitio_water_sources {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  source_type varchar(50) [not null, note: 'natural, level1, level2, level3']
  exists water_source_exists [not null]
  functioning_count integer [note: 'Number of functioning units/stations']
  not_functioning_count integer [note: 'Number of not functioning units/stations']
  
  indexes {
    sitio_data_id [name: 'idx_water_sources_sitio_data']
    (sitio_data_id, source_type) [unique, name: 'idx_water_sources_unique']
  }
  
  Note: 'Water source status (Section G)'
}

Table sitio_sanitation_types {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  sanitation_type varchar(50) [not null, note: 'waterSealed, pitLatrine, communityCR, openDefecation']
  
  indexes {
    sitio_data_id [name: 'idx_sanitation_sitio_data']
  }
  
  Note: 'Sanitation types used by majority (Section G)'
}

// ============================================
// SECTION H: CROPS & LIVESTOCK
// ============================================

Table sitio_crops {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  crop_name varchar(100) [not null, note: 'Palay, Corn, Banana, Coconut, etc.']
  
  indexes {
    sitio_data_id [name: 'idx_crops_sitio_data']
  }
  
  Note: 'Main crops produced (Section H)'
}

Table sitio_livestock {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  livestock_type varchar(100) [not null, note: 'Pig, Cow, Kalabaw, Horse, Goat, Chicken, Duck, etc.']
  
  indexes {
    sitio_data_id [name: 'idx_livestock_sitio_data']
  }
  
  Note: 'Livestock and poultry produced (Section H)'
}

// ============================================
// SECTION I: HAZARDS
// ============================================

Table sitio_hazards {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  hazard_type varchar(50) [not null, note: 'flood, landslide, drought, earthquake']
  frequency_description text [note: 'Frequency in past 12 months']
  
  indexes {
    sitio_data_id [name: 'idx_hazards_sitio_data']
    (sitio_data_id, hazard_type) [unique, name: 'idx_hazards_unique']
  }
  
  Note: 'Environmental and natural hazards (Section I)'
}

// ============================================
// SECTION J: PRIORITY NEEDS
// ============================================

Table sitio_priorities {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  priority_name varchar(100) [not null, note: 'waterSystem, communityCR, solarStreetLights, roadOpening, farmTools, healthServices, educationSupport']
  rating priority_rating [not null]
  
  indexes {
    sitio_data_id [name: 'idx_priorities_sitio_data']
    (sitio_data_id, priority_name) [unique, name: 'idx_priorities_unique']
  }
  
  Note: 'Priority interventions with rating scale (Section J)'
}

// ============================================
// SECTION K: ISSUES AND CONCERNS
// ============================================

Table sitio_issues_concerns {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  issue_description text [not null]
  category varchar(100)
  
  indexes {
    sitio_data_id [name: 'idx_issues_sitio_data']
    category [name: 'idx_issues_category']
  }
  
  Note: 'Issues and concerns identified in the sitio'
}

// ============================================
// CUSTOM FORM INDICATORS
// ============================================

Table custom_field_groups {
  id varchar(21) [pk, note: 'nanoid']
  name varchar(255) [not null]
  description text
  icon varchar(50) [note: 'Icon identifier (e.g., Folder, Layers, Users)']
  is_collapsible boolean [not null, default: true]
  display_order integer [not null, default: 0, note: 'Order in which groups appear']
  
  created_at timestamp [not null, default: `now()`]
  created_by integer [ref: > users.id]
  updated_at timestamp
  updated_by integer [ref: > users.id]
  
  indexes {
    display_order [name: 'idx_custom_groups_order']
    created_at [name: 'idx_custom_groups_created']
  }
  
  Note: 'Custom field groups for organizing dynamic form fields'
}

Table custom_field_definitions {
  id varchar(21) [pk, note: 'nanoid']
  field_name varchar(100) [not null, unique, note: 'Internal field name (camelCase)']
  display_label varchar(255) [not null, note: 'Display label shown in forms']
  data_type varchar(20) [not null, note: 'text, number, boolean, date, array, checkbox, radio']
  
  // Validation Rules (stored as JSONB)
  validation_rules jsonb [not null, note: '{ required, min, max, pattern, options[], allowMultiple }']
  
  // Aggregation & Visualization
  aggregation_type varchar(20) [not null, default: 'sum', note: 'sum, average, count, min, max']
  visualization_config jsonb [note: '{ enableChart, chartType, colorScheme, showTrend, showOnDashboard }']
  
  // Display & Organization
  display_order integer [not null, default: 0]
  is_active boolean [not null, default: true, note: 'false = archived/soft-deleted']
  description text [note: 'Help text for the field']
  
  // Group Association
  group_id varchar(21) [ref: > custom_field_groups.id]
  group_display_order integer [note: 'Display order within the group']
  
  created_at timestamp [not null, default: `now()`]
  created_by integer [ref: > users.id]
  updated_at timestamp
  updated_by integer [ref: > users.id]
  
  indexes {
    field_name [unique, name: 'idx_custom_fields_name']
    group_id [name: 'idx_custom_fields_group']
    display_order [name: 'idx_custom_fields_order']
    is_active [name: 'idx_custom_fields_active']
  }
  
  Note: 'Dynamic custom field definitions created by admins to extend sitio data collection'
}

Table sitio_custom_field_data {
  id integer [pk, increment]
  sitio_data_id integer [not null, ref: > sitio_data.id]
  field_id varchar(21) [not null, ref: > custom_field_definitions.id]
  value jsonb [not null, note: 'Stores the actual value - type depends on field definition']
  
  indexes {
    sitio_data_id [name: 'idx_custom_data_sitio']
    field_id [name: 'idx_custom_data_field']
    (sitio_data_id, field_id) [unique, name: 'idx_custom_data_unique']
  }
  
  Note: 'Stores custom field values for each sitio yearly snapshot'
}

// ============================================
// SYSTEM CONFIGURATIONS
// ============================================

Table system_configurations {
  id integer [pk, increment]
  config_key varchar(100) [not null, unique, note: 'Unique config identifier']
  config_section varchar(50) [not null, note: 'locations, comparisonLimits, nationalAverages, povertyThresholds']
  config_data jsonb [not null, note: 'Configuration data in JSON format']
  description text [note: 'Description of what this configuration controls']
  
  is_active boolean [not null, default: true]
  is_system_default boolean [not null, default: false, note: 'true = built-in default, false = custom override']
  
  created_at timestamp [not null, default: `now()`]
  created_by integer [ref: > users.id]
  updated_at timestamp
  updated_by integer [ref: > users.id]
  
  indexes {
    config_key [unique, name: 'idx_config_key']
    config_section [name: 'idx_config_section']
    is_active [name: 'idx_config_active']
  }
  
  Note: 'System-wide configuration settings (municipalities, thresholds, national averages, etc.)'
}

// ============================================
// USER MANAGEMENT
// ============================================

Table users {
  id integer [pk, increment]
  name varchar(255) [not null]
  email varchar(255) [unique, not null]
  password_hash varchar(255) [not null]
  role user_role [not null, default: 'viewer']
  department varchar(100)
  is_active boolean [not null, default: true]
  
  // JSONB for flexible permissions
  permissions jsonb [not null, note: '{ sitios: {read, write, delete}, sitio_data: {...}, projects: {...}, users: {...}, audit_logs: {...} }']
  
  last_login timestamp
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  
  indexes {
    email [unique, name: 'idx_users_email']
    role [name: 'idx_users_role']
    is_active [name: 'idx_users_active']
  }
  
  Note: 'System users with role-based access control and granular permissions'
}

// ============================================
// SYSTEM / AUDIT
// ============================================

Table audit_logs {
  id varchar(21) [pk, note: 'nanoid']
  user_id integer [ref: > users.id]
  user_name varchar(255) [not null, note: 'Denormalized for historical accuracy']
  action audit_action [not null]
  resource_type audit_resource_type [not null]
  resource_id varchar(50) [note: 'ID of affected resource']
  resource_name varchar(255) [note: 'Name/title of affected resource']
  details text [note: 'Additional context or changes summary']
  changes jsonb [note: '[{ field, oldValue, newValue }]']
  ip_address varchar(45)
  timestamp timestamp [not null, default: `now()`]
  
  indexes {
    timestamp [name: 'idx_audit_logs_timestamp']
    user_id [name: 'idx_audit_logs_user']
    resource_type [name: 'idx_audit_logs_resource_type']
    action [name: 'idx_audit_logs_action']
  }
  
  Note: 'Comprehensive audit trail for all system actions'
}

// ============================================
// TABLE GROUPS (for diagram organization)
// ============================================

TableGroup location_hierarchy [color: #f39c12] {
  municipalities
  barangays
}

TableGroup core_entities [color: #3498db] {
  sitios
  sitio_data
  projects
  users
}

TableGroup projects_related [color: #16a085] {
  project_sitios
  project_images
}

TableGroup facilities_infrastructure [color: #9b59b6] {
  sitio_facilities
  sitio_infrastructure
}

TableGroup water_sanitation [color: #1abc9c] {
  sitio_water_sources
  sitio_sanitation_types
}

TableGroup agriculture [color: #27ae60] {
  sitio_crops
  sitio_livestock
}

TableGroup safety_priorities [color: #e67e22] {
  sitio_hazards
  sitio_priorities
  sitio_issues_concerns
}

TableGroup custom_fields [color: #8e44ad] {
  custom_field_groups
  custom_field_definitions
  sitio_custom_field_data
}

TableGroup system [color: #e74c3c] {
  system_configurations
  audit_logs
}
