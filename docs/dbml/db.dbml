// ============================================
// SC Sitio Profiling System
// Entity-Relationship Diagram (DBML)
// ============================================
// MongoDB Document Schema
// Fully denormalized with embedded documents and arrays
// ============================================

Project sc_sitio_profiling {
  database_type: 'MongoDB'
  Note: 'South Cotabato Sitio Profiling System - Community data collection and monitoring'
}

// ============================================
// ENUMS
// ============================================

enum official_type {
  local [note: 'Local barangay/sitio official']
  rst [note: 'Resident Support Team official']
}

enum user_role {
  superadmin [note: 'Full system access']
  admin [note: 'Can manage sitios and data']
  viewer [note: 'Read-only access']
}

enum audit_action {
  login
  logout
  create
  update
  delete
  view
  export
  import
}

enum audit_resource_type {
  user
  sitio
  sitio_data
  project
  system
}

enum mobile_signal {
  none [note: 'No mobile signal']
  two_g [note: '2G']
  three_g [note: '3G']
  four_g [note: '4G']
  five_g [note: '5G']
}

enum students_per_room {
  less_than_46 [note: 'Less than 46 students']
  from_46_to_50 [note: '46-50 students']
  from_51_to_55 [note: '51-55 students']
  more_than_56 [note: 'More than 56 students']
  no_classroom [note: 'No classroom']
}

enum food_security {
  secure [note: 'Food secure']
  seasonal_scarcity [note: 'Seasonal scarcity']
  critical_shortage [note: 'Critical shortage']
}

// ============================================
// LOCATION HIERARCHY (for reference/seeding only)
// ============================================
// Note: In MongoDB, location data is embedded directly in sitios collection
// These tables are kept for reference and can be used for seeding/validation

Table municipalities {
  id integer [pk, increment]
  name varchar(100) [not null]
  barangays jsonb [note: '[{ id, name, sitios: [{ id, name, sitioCode }] }] - Embedded barangays with nested sitios for quick lookups']
  
  Note: 'Municipality/City reference - can be embedded or kept as reference collection'
}

// ============================================
// CORE ENTITIES
// ============================================

Table sitios {
  id integer [pk, increment]
  name varchar(255) [not null]
  sitio_code varchar(50) [note: 'Purok/Sitio code identifier']
  
  // Embedded location hierarchy (denormalized)
  location jsonb [not null, note: '{ municipalityId, municipalityName, barangayId, barangayName } - Full location path embedded']
  
  coordinates jsonb [not null, note: '{ lat, lng } - Geographic coordinates']
  
  // Embedded yearly data snapshots (denormalized from sitio_data)
  yearly_data jsonb [note: '[{ year, recordedAt, ...all sitio_data fields }] - Array of yearly profiling data']
  
  // Embedded project references
  project_ids jsonb [note: '[projectId1, projectId2, ...] - Array of project IDs that benefit this sitio']
  
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  
  indexes {
    name [name: 'idx_sitios_name']
    "location.municipalityId" [name: 'idx_sitios_municipality']
    "location.barangayId" [name: 'idx_sitios_barangay']
  }
  
  Note: 'Core sitio (community) document - embeds location hierarchy and yearly data snapshots'
}

Table projects {
  id integer [pk, increment]
  title varchar(255) [not null]
  description text [not null]
  
  location jsonb [not null, note: '{ lat, lng } - Project location coordinates']
  
  cost decimal [not null, default: 0, note: 'Total project cost in PHP']
  project_date date [not null, note: 'Date when the project was implemented']
  
  // Embedded sitio references (denormalized from project_sitios)
  sitio_ids jsonb [not null, note: '[sitioId1, sitioId2, ...] - Array of sitio IDs that benefit from this project']
  
  // Embedded images (denormalized from project_images)
  images jsonb [note: '[{ imageData, displayOrder, createdAt }, ...] - Array of base64 encoded images (max 5)']
  
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  
  indexes {
    title [name: 'idx_projects_title']
    project_date [name: 'idx_projects_date']
    created_at [name: 'idx_projects_created']
    sitio_ids [name: 'idx_projects_sitios']
  }
  
  Note: 'Development projects with embedded images and sitio references'
}

// ============================================
// SITIO YEARLY DATA STRUCTURE (embedded in sitios.yearly_data)
// ============================================
// Note: This table definition shows the structure of data embedded in sitios collection
// Each sitio document contains a yearly_data array with objects matching this structure

Table sitio_data {
  id integer [pk, increment, note: 'Not used in MongoDB - this is embedded in sitios.yearly_data array']
  sitio_id integer [not null, ref: > sitios.id, note: 'Not needed in embedded version']
  year_recorded integer [not null, note: 'Year this data was recorded']
  recorded_at timestamp [not null, default: `now()`]
  
  // SECTION A: Sitio Classification
  is_gida boolean [not null, default: false, note: 'Geographically Isolated and Disadvantaged Area']
  is_indigenous boolean [not null, default: false, note: 'Indigenous Community']
  is_conflict_affected boolean [not null, default: false, note: 'Conflict-Affected Area (Past 3 years)']
  
  // Main Access
  access_paved_road boolean [not null, default: false]
  access_unpaved_road boolean [not null, default: false]
  access_footpath boolean [not null, default: false]
  access_boat boolean [not null, default: false]
  
  // SECTION B: Population & Demographics
  total_population integer [not null, default: 0]
  total_households integer [not null, default: 0]
  registered_voters integer [default: 0]
  labor_force_count integer [default: 0]
  school_age_children integer [default: 0]
  
  population_male integer [not null, default: 0]
  population_female integer [not null, default: 0]
  
  // Vulnerable Groups
  muslim_count integer [default: 0]
  ip_count integer [default: 0]
  seniors_count integer [default: 0]
  labor_force_60_to_64_count integer [default: 0]
  unemployed_count integer [default: 0]
  no_birth_cert_count integer [default: 0]
  no_national_id_count integer [default: 0]
  out_of_school_youth integer [default: 0]
  
  // SECTION C: Basic Utilities & Connectivity
  households_with_toilet integer [default: 0]
  households_with_electricity integer [default: 0]
  
  // Electricity Sources
  electricity_grid integer [default: 0]
  electricity_solar integer [default: 0]
  electricity_battery integer [default: 0]
  electricity_generator integer [default: 0]
  
  mobile_signal mobile_signal [not null, default: 'none']
  households_with_internet integer [default: 0]
  
  // SECTION D: Community Facilities (denormalized from sitio_facilities)
  facilities jsonb [note: '{ healthCenter: { exists, count, distanceToNearest, condition }, pharmacy: {...}, communityToilet: {...}, kindergarten: {...}, elementarySchool: {...}, highSchool: {...}, madrasah: {...}, market: {...} }']
  
  // SECTION E: Roads & Internal Infrastructure (denormalized from sitio_infrastructure)
  infrastructure jsonb [note: '{ asphalt: { exists, lengthKm, condition }, concrete: {...}, gravel: {...}, natural: {...} }']
  
  // SECTION F: Education
  students_per_room students_per_room
  
  // SECTION G: Water & Sanitation (denormalized from sitio_water_sources and sitio_sanitation_types)
  water_sources jsonb [note: '{ natural: { exists, functioningCount, notFunctioningCount }, level1: {...}, level2: {...}, level3: {...} }']
  sanitation_types jsonb [note: '["waterSealed", "pitLatrine", "communityCR", "openDefecation"] - array of sanitation types used by majority']
  
  // SECTION H: Livelihood & Agriculture
  private_household_workers integer [default: 0]
  private_establishment_workers integer [default: 0]
  government_workers integer [default: 0]
  self_employed_workers integer [default: 0]
  employer_workers integer [default: 0]
  ofw_workers integer [default: 0]
  
  average_daily_income decimal [default: 0]
  
  number_of_farmers integer [default: 0]
  number_of_associations integer [default: 0]
  estimated_farm_area_hectares decimal [default: 0]
  
  // SECTION H: Crops & Livestock (denormalized from sitio_crops and sitio_livestock)
  crops jsonb [note: '["Palay", "Corn", "Banana", "Coconut", ...] - array of crop names']
  livestock jsonb [note: '["Pig", "Cow", "Kalabaw", "Horse", "Goat", "Chicken", "Duck", ...] - array of livestock types']
  
  // SECTION I: Safety & Risk
  food_security food_security
  
  // SECTION I: Hazards (denormalized from sitio_hazards)
  hazards jsonb [note: '{ flood: { frequencyDescription }, landslide: {...}, drought: {...}, earthquake: {...} }']
  
  // SECTION J: Priority Needs (denormalized from sitio_priorities)
  priorities jsonb [note: '{ waterSystem: "not_needed|low|medium|very_urgent", communityCR: "...", solarStreetLights: "...", roadOpening: "...", farmTools: "...", healthServices: "...", educationSupport: "..." }']
  
  // SECTION K: Issues and Concerns (denormalized from sitio_issues_concerns)
  issues_concerns jsonb [note: '[{ issueDescription, category }, ...] - array of issues and concerns']
  
  Note: 'Sitio profiling data with year-over-year tracking mapped to survey sections - denormalized for simplified queries'
}

// ============================================
// CUSTOM FORM INDICATORS
// ============================================

Table custom_field_definitions {
  id varchar(21) [pk, note: 'nanoid']
  field_name varchar(100) [not null, unique, note: 'Internal field name (camelCase)']
  display_label varchar(255) [not null, note: 'Display label shown in forms']
  data_type varchar(20) [not null, note: 'text, number, boolean, date, array, checkbox, radio']
  
  // Validation Rules
  validation_rules jsonb [not null, note: '{ required, min, max, pattern, options[], allowMultiple }']
  
  // Aggregation & Visualization
  aggregation_type varchar(20) [not null, default: 'sum', note: 'sum, average, count, min, max']
  visualization_config jsonb [note: '{ enableChart, chartType, colorScheme, showTrend, showOnDashboard }']
  
  // Display & Organization
  display_order integer [not null, default: 0]
  is_active boolean [not null, default: true, note: 'false = archived/soft-deleted']
  description text [note: 'Help text for the field']
  
  // Embedded Group Information (denormalized from custom_field_groups)
  group jsonb [note: '{ id, name, description, icon, isCollapsible, displayOrder } - Embedded group details']
  group_display_order integer [note: 'Display order within the group']
  
  created_at timestamp [not null, default: `now()`]
  created_by integer [ref: > users.id]
  updated_at timestamp
  updated_by integer [ref: > users.id]
  
  indexes {
    field_name [unique, name: 'idx_custom_fields_name']
    "group.id" [name: 'idx_custom_fields_group']
    display_order [name: 'idx_custom_fields_order']
    is_active [name: 'idx_custom_fields_active']
  }
  
  Note: 'Dynamic custom field definitions with embedded group information'
}

// ============================================
// CUSTOM FIELD DATA (embedded in sitios.yearly_data[].custom_fields)
// ============================================
// Note: Custom field data is embedded directly in sitios.yearly_data array
// Structure: sitios.yearly_data[].custom_fields = { fieldId1: value1, fieldId2: value2, ... }

Table sitio_custom_field_data {
  id integer [pk, increment, note: 'Not used in MongoDB - embedded in sitios.yearly_data[].custom_fields']
  sitio_data_id integer [not null, ref: > sitio_data.id, note: 'Not needed in embedded version']
  field_id varchar(21) [not null, ref: > custom_field_definitions.id]
  value jsonb [not null, note: 'Stores the actual value - type depends on field definition']
  
  Note: 'REFERENCE ONLY - In MongoDB, custom field values are embedded in sitios.yearly_data[].custom_fields as key-value pairs'
}

// ============================================
// SYSTEM CONFIGURATIONS
// ============================================

Table system_configurations {
  id integer [pk, increment]
  config_key varchar(100) [not null, unique, note: 'Unique config identifier']
  config_section varchar(50) [not null, note: 'locations, comparisonLimits, nationalAverages, povertyThresholds']
  config_data jsonb [not null, note: 'Configuration data in JSON format']
  description text [note: 'Description of what this configuration controls']
  
  is_active boolean [not null, default: true]
  is_system_default boolean [not null, default: false, note: 'true = built-in default, false = custom override']
  
  created_at timestamp [not null, default: `now()`]
  created_by integer [ref: > users.id]
  updated_at timestamp
  updated_by integer [ref: > users.id]
  
  indexes {
    config_key [unique, name: 'idx_config_key']
    config_section [name: 'idx_config_section']
    is_active [name: 'idx_config_active']
  }
  
  Note: 'System-wide configuration settings (municipalities, thresholds, national averages, etc.)'
}

// ============================================
// USER MANAGEMENT
// ============================================

Table users {
  id integer [pk, increment]
  name varchar(255) [not null]
  email varchar(255) [unique, not null]
  password_hash varchar(255) [not null]
  role user_role [not null, default: 'viewer']
  department varchar(100)
  is_active boolean [not null, default: true]
  
  // JSONB for flexible permissions
  permissions jsonb [not null, note: '{ sitios: {read, write, delete}, sitio_data: {...}, projects: {...}, users: {...}, audit_logs: {...} }']
  
  last_login timestamp
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  
  indexes {
    email [unique, name: 'idx_users_email']
    role [name: 'idx_users_role']
    is_active [name: 'idx_users_active']
  }
  
  Note: 'System users with role-based access control and granular permissions'
}

// ============================================
// PENDING CHANGES / APPROVAL WORKFLOW
// ============================================

enum pending_change_status {
  pending [note: 'Awaiting review']
  approved [note: 'Approved by admin']
  rejected [note: 'Rejected by admin']
  superseded [note: 'Superseded by newer change']
  conflict [note: 'Conflict detected with current data']
}

enum pending_resource_type {
  sitio [note: 'Sitio data changes']
  project [note: 'Project changes']
}

Table pending_changes {
  id varchar(21) [pk, note: 'nanoid']
  resource_type pending_resource_type [not null]
  resource_id integer [not null, note: 'Sitio or Project ID']
  resource_name varchar(255) [not null, note: 'Display name of the resource']
  status pending_change_status [not null, default: 'pending']
  
  // Data snapshots
  original_data jsonb [not null, note: 'Snapshot of data at time of submission']
  proposed_data jsonb [not null, note: 'The proposed changes']
  base_version_hash varchar(64) [not null, note: 'Hash of original data for conflict detection']
  
  // Submission details
  submitted_by_user_id integer [not null, ref: > users.id]
  submitted_by_user_name varchar(255) [not null, note: 'Denormalized for history']
  submitted_at timestamp [not null, default: `now()`]
  submitter_comment text [note: 'Optional comment from submitter explaining the change']
  
  // Review details
  reviewed_by_user_id integer [ref: > users.id]
  reviewed_by_user_name varchar(255) [note: 'Denormalized for history']
  reviewed_at timestamp
  reviewer_comment text [note: 'Optional comment from reviewer explaining the decision']
  
  // Conflict details
  conflict_details jsonb [note: '[{ field, currentValue, proposedValue }]']
  
  indexes {
    status [name: 'idx_pending_changes_status']
    resource_type [name: 'idx_pending_changes_resource_type']
    resource_id [name: 'idx_pending_changes_resource_id']
    submitted_by_user_id [name: 'idx_pending_changes_submitter']
    reviewed_by_user_id [name: 'idx_pending_changes_reviewer']
    submitted_at [name: 'idx_pending_changes_submitted']
    (resource_type, resource_id, status) [name: 'idx_pending_changes_resource_status']
  }
  
  Note: 'Pending change requests awaiting admin review/approval - enables approval workflow for data changes'
}

// ============================================
// SYSTEM / AUDIT
// ============================================

Table audit_logs {
  id varchar(21) [pk, note: 'nanoid']
  user_id integer [ref: > users.id]
  user_name varchar(255) [not null, note: 'Denormalized for historical accuracy']
  action audit_action [not null]
  resource_type audit_resource_type [not null]
  resource_id varchar(50) [note: 'ID of affected resource']
  resource_name varchar(255) [note: 'Name/title of affected resource']
  details text [note: 'Additional context or changes summary']
  changes jsonb [note: '[{ field, oldValue, newValue }]']
  ip_address varchar(45)
  timestamp timestamp [not null, default: `now()`]
  
  indexes {
    timestamp [name: 'idx_audit_logs_timestamp']
    user_id [name: 'idx_audit_logs_user']
    resource_type [name: 'idx_audit_logs_resource_type']
    action [name: 'idx_audit_logs_action']
  }
  
  Note: 'Comprehensive audit trail for all system actions'
}

// ============================================
// TABLE GROUPS (for diagram organization)
// ============================================

TableGroup location_hierarchy [color: #f39c12] {
  municipalities
  barangays
}

TableGroup core_entities [color: #3498db] {
  sitios
  projects
  users
}

TableGroup reference_structures [color: #95a5a6] {
  sitio_data
  sitio_custom_field_data
}

TableGroup custom_fields [color: #8e44ad] {
  custom_field_definitions
}

TableGroup approval_workflow [color: #e67e22] {
  pending_changes
}

TableGroup system [color: #e74c3c] {
  system_configurations
  audit_logs
}
